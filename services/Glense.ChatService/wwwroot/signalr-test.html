<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Glense ChatService SignalR Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
  <h2>Glense ChatService SignalR Test</h2>
  <label>Chat ID: <input id="chatId" value="test-chat" /></label><br />
  <label>User: <input id="user" value="alice" /></label><br />
  <label>JWT: <input id="token" style="width:80%" /></label><br />
  <button id="btnJoin">Join Chat</button>
  <button id="btnLeave">Leave Chat</button>
  <div>
    <input id="msg" style="width:60%" /> <button id="btnSend">Send</button>
  </div>
  <ul id="messages"></ul>

  <script>
    const chatIdEl = document.getElementById('chatId');
    const userEl = document.getElementById('user');
    const tokenEl = document.getElementById('token');
    const btnJoin = document.getElementById('btnJoin');
    const btnLeave = document.getElementById('btnLeave');
    const btnSend = document.getElementById('btnSend');
    const msgEl = document.getElementById('msg');
    const messages = document.getElementById('messages');

    // Assumes ChatService is hosted under the same origin where this file is served.
    const hubUrl = `${location.origin.replace(/:\d+$/, '')}:${location.port}/hubs/chat`;

    let connection = null;

    function addMessage(text){
      const li = document.createElement('li');
      li.textContent = text;
      messages.appendChild(li);
    }

    function ensureConnection(){
      if(connection) return connection;
      connection = new signalR.HubConnectionBuilder()
        .withUrl('/hubs/chat', {
          accessTokenFactory: () => tokenEl.value || null
        })
        .withAutomaticReconnect()
        .build();

      connection.on('ReceiveMessage', (chatId, user, message) => {
        addMessage(`[${chatId}] ${user}: ${message}`);
      });

      connection.start().then(()=> addMessage('SignalR connected')).catch(err=> addMessage('SignalR connect error: '+err));
      return connection;
    }

    btnJoin.addEventListener('click', async ()=>{
      try{
        const c = ensureConnection();
        await c.invoke('JoinChat', chatIdEl.value);
        addMessage('Joined '+chatIdEl.value);
      }catch(e){ addMessage('Join error: '+e); }
    });

    btnLeave.addEventListener('click', async ()=>{
      try{ const c = ensureConnection(); await c.invoke('LeaveChat', chatIdEl.value); addMessage('Left '+chatIdEl.value); } catch(e){ addMessage('Leave error: '+e); }
    });

    btnSend.addEventListener('click', async ()=>{
      try{ const c = ensureConnection(); await c.invoke('SendMessageToChat', chatIdEl.value, userEl.value, msgEl.value); msgEl.value=''; } catch(e){ addMessage('Send error: '+e); }
    });
  </script>
</body>
</html>